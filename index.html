<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div id="map"></div>
    
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="./leaflet.ajax.min.js"></script>
    <script src="./leaflet.rotatedMarker.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='polygonSmooth.js'></script>
    <script src="data.js"></script>
    <script>
        function randomColor() {
            return '#' + Math.floor(Math.random() * 0xffffff).toString(16)
        }

        var breaks = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 9999]
        var map = L.map('map', {
            // minZoom: 7,
            // maxBounds: L.latLngBounds(L.latLng(24.5, 108.6), L.latLng(30.3, 114.4)),
            maxBoundsViscosity: 1.0
        }).setView([27.4, 111.5], 7);
        // map.setMaxBounds(map.getBounds())

        // 点标记图层
        var markerLayer = L.layerGroup()
        var extent = [108.6, 24.5, 114.4, 30.3]
        var points = turf.randomPoint(97, { bbox: extent })
        turf.featureEach(points, function (point) {
            point.properties.val = Math.random() * 50
        })
        L.geoJSON(points, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: randomColor(),
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup('val: ' + feature.properties.val)
            }
        }).addTo(markerLayer)

        // 数值标记图层
        var numberMakerLayer = L.layerGroup()
        L.geoJSON(points, {
            pointToLayer: function (feature, latlng) {
                var icon = L.divIcon({ html: feature.properties.val.toFixed(2), className: 'text-marker' })
                return L.marker(latlng, { icon: icon })
            }
        }).addTo(numberMakerLayer)

        // 图片标记图层
        var imageMakerLayer = L.layerGroup()
        var baseballIcon = L.icon({
            iconUrl: 'baseball-marker.png',
            iconSize: [32, 37],
            iconAnchor: [16, 37],
            popupAnchor: [0, -28],
            className: 'rotate'
        })
        L.geoJSON(points, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, { 
                    icon: baseballIcon
                })
            }
        }).addTo(imageMakerLayer)

        // 风向图标标记图层
        var windMakerLayer = L.layerGroup()
        var windIcon = L.icon({
            iconUrl: 'wind.png', // baseball-marker
            iconSize: [32, 37],
            iconAnchor: [16, 37],
            popupAnchor: [0, -28],
            className: 'rotate'
        })
        L.geoJSON(points, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, { 
                    icon: windIcon, 
                    rotationAngle: Math.random() * 360
                })
            }
        }).addTo(windMakerLayer)

        // 底图图层
        var tileLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.light'
        })

        // 14个地市边界图层
        var cityLayer = L.layerGroup()
        ;[57687, 57662, 57558, 57674, 57749, 57763, 57766, 57773, 57872, 57972, 57780, 57584, 57866, 57649].forEach(function(code) {
            L.geoJson.ajax('./geojson/' + code + '.json', {
                style: function (feature) {
                    return feature.properties && feature.properties.style
                }
            }).addTo(cityLayer)
        })
        
        // 湖南省边界图层
        var provinceLayer = L.geoJson.ajax('./geojson/hunan.json', {
            style: function (feature) {
                return feature.properties && feature.properties.style
            }
        })
        provinceLayer.addTo(map)

        // 色斑图层
        var spotLayer = L.layerGroup()
        $.get('./grids/TMAX-2018090108.json', function (grid) {
            map.createPane('isosurface')
            map.getPane('isosurface').style.zIndex = 399

            console.time('isobands')
            var polygons = turf.isobands(grid, breaks, { zProperty: 'val' })
            var polygon = turf.polygonSmooth(polygons, { iterations: 3 })
            console.timeEnd('isobands')

            L.geoJSON(polygon, {
                style: function (feature) {
                    var color = randomColor(feature.properties.val)
                    return {
                        // stroke: false,
                        weight: 1,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.5
                    }
                },
                pane: 'isosurface'
            }).addTo(spotLayer)
        })

        // 添加图层控件
        L.control.layers({
            // ...
        }, {
            "底图": tileLayer,
            "省界": provinceLayer,
            "市界": cityLayer,
            "色斑": spotLayer,
            "点标记": markerLayer,
            "数值标记": numberMakerLayer,
            "图片标记": imageMakerLayer,
            "风向标记": windMakerLayer,
        }).addTo(map)
        

        // var breaks = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 9999]//[0, 10, 20, 50, 100, 500];

        // // 通过turf实现IDW插值
        // console.time('interpolate')
        // var extent = [108.6, 24.5, 114.4, 30.3];
        // var points = turf.randomPoint(97, { bbox: extent })
        // turf.featureEach(points, function (point) {
        //     point.properties.val = Math.random() * 50;
        // });
        // var options = { gridType: 'point', property: 'val', units: 'kilometers' };
        // var grid = turf.interpolate(points, 20, options);
        // console.timeEnd('interpolate')

        // // 通过Java实现IDW插值(本地测试将get回调方法内部代码拿出来就行)
        // // $.get('http://192.168.1.110:8080/task/interpolate', function (grid) {
        // $.get('./grids/TMAX-2018090108.json', function (grid) {
        //     console.time('isobands')
        //     var polygons = turf.isobands(grid, [-40,-30,-20,-10,0,10,20,30,40,45,9999] || breaks, { zProperty: 'val' })
        //     var polygon = turf.polygonSmooth(polygons, { iterations: 3 })
        //     console.timeEnd('isobands')
        //     console.log(polygon)

        //     console.time('isosurface')
        //     var isosurface = L.geoJSON([polygon], {
        //         style: function (feature) {
        //             if (feature.geometry.type !== 'Point') {
        //                 var color = randomColor(feature.properties.val)
        //                 return {
        //                     // stroke: false,
        //                     weight: 1,
        //                     color: color,
        //                     fillColor: color,
        //                     fillOpacity: 0.5
        //                 }
        //             }
        //         },
        //         pointToLayer: function (feature, latlng) {
        //             return L.circleMarker(latlng, {
        //                 radius: 5,
        //                 fillColor: "#ff7800",
        //                 color: "#000",
        //                 weight: 1,
        //                 opacity: 1,
        //                 fillOpacity: 0.8
        //             }).bindPopup('val: ' + feature.properties.val);
        //         },
        //         pane: 'isosurface'
        //     })
        //     isosurface.addTo(map)
        //     console.timeEnd('isosurface')

            
        // })

    </script>
</body>

</html>