<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Display a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='mapbox-gl.css' rel='stylesheet' />
    <script src='mapbox-gl.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #log {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100000;
            background-color: #000;
            /* opacity: 0.3; */
            color: white;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="log"></div>
    <div id='map'></div>

    <script src="jquery.min.js"></script>
    <script src="./cityAndTownsData.js"></script>
    <script>
        var Utils = {
            randomColor: function(val) {
                return '#' + (val === 0 ? 'ffffff' : Math.floor(Math.random() * 0xffffff).toString(16))
            },
            getRange: function(val, breaks) {
                var range = breaks || [0, 10, 20, 50, 100]
                for (var i = 0, len = range.length; i < len; i++) {
                    if (i === 0 && val < range[i]) {
                        return '$-' + range[i]
                    }

                    if (i === len - 1 && val >= range[i]) {
                        return range[i] + '-$'
                    }

                    if (val >= range[i] && val < range[i + 1]) {
                        return range[i] + '-' + range[i + 1]
                    }
                }

                throw new Error('fail...')
            },
            convertToGeoJSON: function(data, name) {
                return data.map(function(v) {
                    return {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [Number(v.lon), Number(v.lat)]
                        },
                        "properties": {
                            "title": v[name]
                        }
                    }
                })
            },
            createDefaultTextLayerOptions: function(id, features) {
                return {
                    "id": id,
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": features
                        }
                    },
                    "layout": {
                        "icon-image": "point",
                        "icon-size": 0.5,
                        "text-size": 14,
                        "text-field": "{title}",
                        "text-offset": [0, 0.3],
                        "text-anchor": "top",
                        "text-font": ["Microsoft YaHei Regular"],
                        "text-allow-overlap": true,
                        "text-ignore-placement": true,
                    }
                }
            }
        }

        var GeoJSON = {
            city: {
                name: 'city',
                json: Utils.convertToGeoJSON(cityData, 'city')
            },
            cnty: {
                name: 'cnty',
                json: Utils.convertToGeoJSON(cntyData, 'cnty')
            },
            station: {
                name: 'station',
                json: Utils.convertToGeoJSON(townsStationData, 'station')
            },
            mock: {
                name: 'mock',
                json: cntyData.map(function(v) {
                    var val = parseInt(Math.random() * 100)
                    var color = Utils.randomColor()
                    return {
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [Number(v.lon), Number(v.lat)]
                        },
                        "properties": {
                            "title": v.cnty,
                            "value": val,
                            "icon": Utils.getRange(val),
                            "color": color
                        }
                    }
                })
            }
        }

        mapboxgl.accessToken = 'pk.eyJ1IjoiaWZ6bSIsImEiOiJjamswc3M1a2gwYWEwM3Zxa3ZsMjh3djkwIn0.h93-XtdRdtoC1KbVv_ZIow';
        var map = new mapboxgl.Map({
            container: 'map',
            center: [111.5, 27.4],
            zoom: 5,
            minZoom: 5,
            maxBounds: [[104.94, 20.89], [118.03, 33.52]],
            // style: 'mapbox://styles/ifzm/cjnbezsim0bh62sqqiao9g3vc',
            style: {
                "version": 8,
                "sources": {
                    // "composite": {
                    //     "url": "mapbox://ifzm.cjnn1u32v024l2qmzv5qbr34i-30s8t,ifzm.cjnn282t700rt2wt1zl88rvia-3ptil",
                    //     "type": "vector"
                    // }
                    "composite": {
                        "name": "county-boundary + city-boundary",
                        "type": "vector",
                        "scheme": "xyz",
                        "bounds": [
                            108.790841,
                            24.636323,
                            114.261264,
                            30.126363
                        ],
                        "maxzoom": 12,
                        "minzoom": 0,
                        "tilejson": "2.2.0",
                        "format": "pbf",
                        "mapbox_logo": false,
                        "tiles": [
                            "http://192.168.1.180:8090/task/proxyTile/{z}/{x}/{y}.vector.pbf"
                            // "https://a.tiles.mapbox.com/v4/ifzm.cjnn1u32v024l2qmzv5qbr34i-30s8t,ifzm.cjnn282t700rt2wt1zl88rvia-3ptil/{z}/{x}/{y}.vector.pbf?access_token=pk.eyJ1IjoiaWZ6bSIsImEiOiJjamswc3M1a2gwYWEwM3Zxa3ZsMjh3djkwIn0.h93-XtdRdtoC1KbVv_ZIow",
                            // "https://b.tiles.mapbox.com/v4/ifzm.cjnn1u32v024l2qmzv5qbr34i-30s8t,ifzm.cjnn282t700rt2wt1zl88rvia-3ptil/{z}/{x}/{y}.vector.pbf?access_token=pk.eyJ1IjoiaWZ6bSIsImEiOiJjamswc3M1a2gwYWEwM3Zxa3ZsMjh3djkwIn0.h93-XtdRdtoC1KbVv_ZIow"
                        ]
                    }
                },
                "sprite": "mapbox://sprites/ifzm/cjnbezsim0bh62sqqiao9g3vc",
                // "sprite": "http://192.168.1.180:5500/sprite/sprite",
                "glyphs": "./{fontstack}/{range}.pbf",
                // "glyphs": "mapbox://fonts/ifzm/{fontstack}/{range}.pbf",
                "layers": [
                    {
                        "id": "background",
                        "type": "background",
                        "layout": {},
                        "paint": {"background-color": "rgba(0,0,0,0)"}
                    },
                    {
                        "id": "city-boundary",
                        "type": "line",
                        "source": "composite",
                        "source-layer": "city-boundary",
                        "filter": ["in", "$type", "LineString", "Point", "Polygon"],
                        "layout": {},
                        "paint": {"line-color": "hsl(0, 0%, 86%)"}
                    },
                    {
                        "id": "county-boundary",
                        "type": "line",
                        "source": "composite",
                        "source-layer": "county-boundary",
                        "minzoom": 8,
                        "layout": {},
                        "paint": {"line-color": "hsl(0, 0%, 89%)"}
                    }
                ]
            }
        });

        var addLayer = map.addLayer
        map.addLayer = function(o) {
            console.log(arguments)
            addLayer.apply(map, arguments)
        }

        map.on('load', function () {
            map.dragRotate.disable();
            map.touchZoomRotate.disableRotation();

            map.addLayer(Utils.createDefaultTextLayerOptions(GeoJSON.city.name, GeoJSON.city.json))
            map.addLayer(Utils.createDefaultTextLayerOptions(GeoJSON.cnty.name, GeoJSON.cnty.json))
            map.addLayer(Utils.createDefaultTextLayerOptions(GeoJSON.station.name, GeoJSON.station.json))
            map.setLayerZoomRange(GeoJSON.city.name, 4, 11)
            map.setLayerZoomRange(GeoJSON.cnty.name, 8, 11)
            map.setLayerZoomRange(GeoJSON.station.name, 11, 18)

            // 省界
            $.getJSON('./geojson/hu-nan-sheng.json', function(json) {
                map.addLayer({
                    "id": "hu-nan-sheng-fill",
                    "type": "fill",
                    "source": {
                        "type": "geojson",
                        "data": json
                    },
                    "paint": {
                        "fill-color": "#ffffff",
                        "fill-opacity": 1
                    }
                }, GeoJSON.station.name)

                map.addLayer({
                    "id": "hu-nan-sheng-line",
                    "type": "line",
                    "source": {
                        "type": "geojson",
                        "data": json
                    }
                }, GeoJSON.station.name)
            })

            map.on('click', 'points', function (e) {
                alert(e.features[0].properties.title)
                console.log(e.features[0])
            })

            $.getJSON('./test-geojson.json', function (json) {
                var start = Date.now()
                console.time('polygons')
                map.addSource('tmax', {
                    type: 'geojson',
                    data: json
                })

                map.addLayer({
                    id: 'fill-layer-aaa',
                    "type": "fill",
                    "source": "tmax",
                    "paint": {
                        "fill-color": { 
                            "type": "identity", 
                            "property": "color" 
                        },
                        "fill-opacity": 0.5
                    }
                }, 'city-boundary')

                console.timeEnd('polygons')
                $('#log').append(`<div>polygons time: ${Date.now() - start}ms</div>`)
            })
        })
    </script>

</body>

</html>